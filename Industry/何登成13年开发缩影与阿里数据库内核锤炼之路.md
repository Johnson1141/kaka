## [何登成13年开发缩影与阿里数据库内核锤炼之路](https://mp.weixin.qq.com/s/nRq7MVPZfjtj3-T_KZOlEg)

### 双十一
2017年，秒级 32.5 万的交易峰值，团队真正做到了双 11 前 CTO 定下的“喝着茶过双 11”的基调，值班的技术同学也很快的进入了买买买的剁手行列之中。

#### 发现问题
数据库团队来说，并不知道每个集群的压力在双 11 零点峰值会有多大？哪个数据库集群会最先碰到瓶颈？每个集群需要扩容多少机器？双 11 备战时间过长，能不能缩短？双 11 参与的技术人员过多，能不能减少？双 11 的硬件资源开销过大，能不能降低？

#### 技术思路
1. 将双 11 从技术上的一个未知问题转变为一个已知问题，然后每年对这个已知问题进行求解。
2. 当团队将未知问题转化为已知问题之后，就在不断地思考：现有的解决方案是否是最优方案，在技术上是否有改进的空间。

### 数据库产品线
#### AliSQL
阿里巴巴数据库内核研发团队组建于 2010 年，成立初期的目标就是去 IOE，早期的产品是开源 MySQL 的阿里巴巴分支 AliSQL，对 MySQL 在性能、功能和可运维性等方面，做了大量的改进

#### X-DB
结合 AliSQL 和自研高性能分布式一致性算法 X-Paxos、自研高性能低成本存储引擎 X-Engine，全面兼容 MySQL 生态，数据强同步，自动选主，一跃成为一个达到金融级别可靠性和可用性的数据库。在今年的双 11 核心集群上大规模部署。

* 一体化理念：没有任何第三方的外部组件依赖，对业务实现了透明化的数据 Sharding 能力以及跨 AZ（同城多机房）、Region（跨城部署）甚至是全球化部署的能力，5 个 9 以上的持续可用率。
* 存储计算分离：数据库的计算存储分离本身不难，难的是计算存储分离之后，访问存储层数据的延时增加对性能的负面影响。数据库计算存储分离在2017年双 11 核心集群落地，将数据库从一个重量级的有状态系统转化为一个轻量级的无状态系统，具备了等同于业务系统的弹性能力。
* 兼容成熟生态：对 MySQL 生态下的运维系统 / 工具、知识体系实现了兼容，整个 MySQL 时代的支撑平台和人员都可以平滑的过度到分布式数据库时代，拥有了支撑下一代数据库的能力。

（译者注：对比mintplus，raft替代zk体现了一体化，借助paas实现了弹性伸缩，兼容redis协议成熟生态。）

#### X-KV
核心集群在双 11 的读压力非常大，传统的解决方案是在数据库前端搭建缓存。但是增加缓存会带来数据一致性问题同时增加架构复杂性。

将缓存和数据库融合在一起，通过 KV 接口直接访问数据库存储引擎中的数据，一来消除了数据一致性问题，二来绕过了整个数据库的 SQL 层，极大地提升了数据库的读能力。经过验证，通过 KV 接口直接读取数据库，在我们某一个数据库核心集群上，相对于 SQL 接口有着近 5 倍的性能提升。

#### X-Engine
传统架构下的数据库系统，只有 6.8% 的 CPU 资源做的是有用功，而绝大部分的 CPU 都消耗在了 2B3L 上（2B：B+Tree，Buffer Pool；3L：Logging，Locking，Latching）。软件的性能提升越来越赶不上硬件的更新换代，软件系统内部的并发瓶颈极大的限制了系统在多核上的扩展性，往往一台主机上需要部署多个数据库实例，才能将硬件的资源耗尽。

设计理念：在 100% 兼容 MySQL 生态的前提下，面向软硬件 Co-Design，通过更亲和现代硬件的软件架构来释放硬件的效率，让每个 CPU 的周期，每个内外存的 bit，每个网卡的 IO 都产生业务价值。

落地：针对内存以及不同外存的特性分别设计更亲和其硬件特性的数据结构和算法，充分提高多种硬件的效率。例如：在内存和 CPU 缓存层面，X-Engine 实现了非常亲和 CPU 缓存的内存索引结构；在外存层面，X-Engine 对 NVRAM、SSD、HDD 等多种外存硬件采用分层存储，不同的存储层根据硬件特征保存不同数据格式和业务意义的数据，提升存储效率。无锁数据结构，轻量级锁，乐观并发控制实现来减少上下文的切换，进而减少 CPU 的 stall；同时引入 FPGA 等异构计算芯片，将compression、compaction 等矢量计算逻辑下沉到异构计算。将 DPDK、RDMA、用户态协议栈等下一代网络架构融合到自身的分布式层中，提升分布式一致性、分布式存储、分布式事务的效率。

在标准的 Sysbench 纯写、纯读测试场景下，32-Core（64-HyperThread），基于 X-Engine 的 X-DB 数据库，单实例能够做到近 65 万的 TPS 和 150 万 + 的 QPS。

#### AIOPs
CloudDBA：做到了所有的 SQL 打标、采集、追踪和智能化分析，通过全量的数据收集，辅以机器学习的算法，今年的双 11 人力投入，相对于之前有了极大的降低。

DBPaaS：数据库监控也从早期的分钟级一路进化到现在的秒级，秒级监控，能够发现毫秒级的抖动。

EagleEye：鹰眼，分布式调用跟踪系统。

基于真实线上部署的全链路压测平台。

### 个人技术发展
>一直到现在我都是这样要求团队的同学的，要关注 CPU、内存、外存、网络的实现架构，要用软硬件 Co-Design 的思维来指导架构设计和开发，这也是 X-DB 高性能的源泉。

案例：我在网易开发 TNT 引擎的时候，遇到过一个十分诡异的性能问题。引擎在高负载下会出现诡异的性能抖动，个别系统 mutex 偶尔会出现调度异常。在开发数据库引擎的时候，为了追求更高的效率，一般都会自己实现 mutex，但是多位同学都 Review 了加锁和释放锁的代码，逻辑均没有异常。

排查陷入了僵局，既然逻辑没问题，那就只可能是执行的问题了，我那时候刚做过 CPU 架构的分享，突然就想到 X86 CPU 虽然很少乱序，但也是有 LoadStore 乱序的可能性的。我就带着这个可能重新 Review 了代码，发现了在 unlock 的实现逻辑中对于 lockword 的写和 waiters 的读有可能存在乱序，导致没有调用唤醒落地，从而出现 mutex 调度异常。